name: Sync Newsletters to reMarkable

on:
  # Run daily at 8 AM UTC
  schedule:
    - cron: '0 8 * * *'

  # Allow manual triggering
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libpango-1.0-0 \
            libpangoft2-1.0-0 \
            libharfbuzz0b \
            libffi-dev \
            libjpeg-dev \
            libopenjp2-7-dev \
            libgdk-pixbuf2.0-0

      - name: Install Python dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: Create config file
        run: |
          cat > config.yaml << 'EOF'
          email_accounts:
            - provider: gmail
              email: ${{ secrets.GMAIL_EMAIL }}
              password_env: GMAIL_PASSWORD
              imap_server: imap.gmail.com
              imap_port: 993
              folder: ${{ secrets.GMAIL_FOLDER || 'INBOX' }}
              allowed_senders: []

            - provider: icloud
              email: ${{ secrets.ICLOUD_EMAIL }}
              password_env: ICLOUD_PASSWORD
              imap_server: imap.mail.me.com
              imap_port: 993
              folder: ${{ secrets.ICLOUD_FOLDER || 'INBOX' }}
              allowed_senders: []

          remarkable:
            one_time_code_env: REMARKABLE_TOKEN
            folder_name: Newsletters

          cleanup:
            max_age_days: 30

          sync:
            lookback_days: 7
            mark_as_read: true
          EOF

      - name: Restore tracker cache
        uses: actions/cache@v4
        with:
          path: tracker.json
          key: remarkable-tracker-${{ github.run_id }}
          restore-keys: |
            remarkable-tracker-

      - name: Restore reMarkable token cache
        uses: actions/cache@v4
        with:
          path: ~/.rmapi
          key: remarkable-token-${{ github.repository }}
          restore-keys: |
            remarkable-token-

      - name: Run sync
        env:
          GMAIL_PASSWORD: ${{ secrets.GMAIL_PASSWORD }}
          ICLOUD_PASSWORD: ${{ secrets.ICLOUD_PASSWORD }}
          REMARKABLE_TOKEN: ${{ secrets.REMARKABLE_TOKEN }}
        run: |
          python main.py

      - name: Upload sync logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: sync-logs-${{ github.run_number }}
          path: newsletter-sync.log
          retention-days: 7
